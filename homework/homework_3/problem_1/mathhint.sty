% mathhint.sty - LaTeX package for Math Hint VSCode extension
% Provides environments for structuring math problems with hints
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mathhint}[2024/01/01 Math Hint environments for VSCode extension]

% Required packages
\RequirePackage{fancyhdr}
\RequirePackage{xcolor}
\RequirePackage{titlesec}
\RequirePackage{geometry}
\RequirePackage{etoolbox}
\RequirePackage{tcolorbox}

% Toggle for showing/hiding hints in PDF
\newif\ifshowhints
\showhintstrue  % Default: show hints

% Hint styling colors
\definecolor{hintcolor}{RGB}{0, 102, 204}
\definecolor{hintbgcolor}{RGB}{240, 248, 255}

% Hint box style
\newtcolorbox{mathhintbox}{
  colback=hintbgcolor, colframe=hintcolor,
  arc=2mm, boxrule=0.5pt, left=5pt, right=5pt,
  top=5pt, bottom=5pt, before skip=1em, after skip=1em
}

% \mathhint{level}{timestamp}{content}
\newcommand{\mathhint}[3]{%
  \ifshowhints
    \begin{mathhintbox}
      \textbf{[#1] Hint} \hfill \textit{\small #2}
      \par\vspace{0.5em}
      #3
    \end{mathhintbox}
  \fi
}

% \mathsolutioncheck{status}{timestamp}{feedback}
\newcommand{\mathsolutioncheck}[3]{%
  \ifshowhints
    \begin{mathhintbox}
      \textbf{[#1] Solution Check} \hfill \textit{\small #2}
      \par\vspace{0.5em}
      #3
    \end{mathhintbox}
  \fi
}

% Define colors for section delineators
\definecolor{problemcolor}{RGB}{214, 39, 40}
\definecolor{notescolor}{RGB}{148, 103, 189}
\definecolor{solutioncolor}{RGB}{44, 160, 44}
\definecolor{rulecolor}{RGB}{200, 200, 200}

% Storage for context information
\newcommand{\@mathhint@book}{}
\newcommand{\@mathhint@chapter}{}
\newcommand{\@mathhint@chaptertitle}{}
\newcommand{\@mathhint@section}{}
\newcommand{\@mathhint@sectiontitle}{}
\newcommand{\@mathhint@problem}{}

% Context command for specifying book, chapter, section, and problem
% Usage: \mathhintcontext{book=Title, chapter=2, chaptertitle=Flows on the Line,
%                         section=2.1, sectiontitle=A Geometric Way of Thinking, problem=3}
\newcommand{\mathhintcontext}[1]{%
  \setkeys{mathhint}{#1}%
  \mathhint@setupheader%
}

% Key-value parsing
\RequirePackage{keyval}
\define@key{mathhint}{book}{\renewcommand{\@mathhint@book}{#1}}
\define@key{mathhint}{chapter}{\renewcommand{\@mathhint@chapter}{#1}}
\define@key{mathhint}{chaptertitle}{\renewcommand{\@mathhint@chaptertitle}{#1}}
\define@key{mathhint}{section}{\renewcommand{\@mathhint@section}{#1}}
\define@key{mathhint}{sectiontitle}{\renewcommand{\@mathhint@sectiontitle}{#1}}
\define@key{mathhint}{problem}{\renewcommand{\@mathhint@problem}{#1}}
\define@key{mathhint}{lectures}{}  % Parsed by extension, ignored by LaTeX

% Setup fancy header with context information
\newcommand{\mathhint@setupheader}{%
  \pagestyle{fancy}%
  \fancyhf{}% Clear all headers and footers
  % Left header: Book title (if provided)
  \fancyhead[L]{\small\textit{\@mathhint@book}}%
  % Center header: Chapter and Section info
  \fancyhead[C]{\small%
    \ifx\@mathhint@chapter\@empty\else%
      Ch.~\@mathhint@chapter%
      \ifx\@mathhint@chaptertitle\@empty\else: \@mathhint@chaptertitle\fi%
    \fi%
  }%
  % Right header: Section and Problem
  \fancyhead[R]{\small%
    \ifx\@mathhint@section\@empty\else%
      \S\@mathhint@section%
      \ifx\@mathhint@problem\@empty\else, \fi%
    \fi%
    \ifx\@mathhint@problem\@empty\else%
      Problem~\@mathhint@problem%
    \fi%
  }%
  % Footer with page number
  \fancyfoot[C]{\thepage}%
  \renewcommand{\headrulewidth}{0.4pt}%
  \renewcommand{\footrulewidth}{0pt}%
}

% Helper command for section headers
\newcommand{\mathhint@sectionheader}[2]{%
  \vspace{1em}%
  \par\noindent{\large\textbf{\textcolor{#1}{#2}}}%
  \vspace{0.5em}%
  \par%
}

% Helper command for section footer
\newcommand{\mathhint@sectionfooter}{%
  \vspace{0.5em}%
  \noindent\textcolor{rulecolor}{\rule{\textwidth}{0.5pt}}%
  \vspace{1em}%
}

% Problem environment - contains the problem statement
\newenvironment{problem}{%
  \mathhint@sectionheader{problemcolor}{Problem}%
}{%
  \mathhint@sectionfooter%
}

% Notes environment - contains student working notes
\newenvironment{notes}{%
  \mathhint@sectionheader{notescolor}{Notes}%
}{%
  \mathhint@sectionfooter%
}

% Solution environment - contains the solution
\newenvironment{solution}{%
  \mathhint@sectionheader{solutioncolor}{Solution}%
}{%
  \mathhint@sectionfooter%
}

\endinput
