% mathwriteup.sty - LaTeX package for Math Writeup VSCode extension
% Provides environments for structuring math problems with hints
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mathwriteup}[2024/01/01 Math Writeup environments for VSCode extension]

% Required packages
\RequirePackage{fancyhdr}
\RequirePackage{xcolor}
\RequirePackage{titlesec}
\RequirePackage{geometry}
\RequirePackage{etoolbox}
\RequirePackage{tcolorbox}

% Toggle for showing/hiding hints in PDF
\newif\ifshowhints
\showhintstrue  % Default: show hints

% Hint styling colors
\definecolor{hintcolor}{RGB}{0, 102, 204}
\definecolor{hintbgcolor}{RGB}{240, 248, 255}

% Hint box style
\newtcolorbox{mathhintbox}{
  colback=hintbgcolor, colframe=hintcolor,
  arc=2mm, boxrule=0.5pt, left=5pt, right=5pt,
  top=5pt, bottom=5pt, before skip=1em, after skip=1em
}

% \mathhint{level}{timestamp}{content}
\newcommand{\mathhint}[3]{%
  \ifshowhints
    \begin{mathhintbox}
      \textbf{[#1] Hint} \hfill \textit{\small #2}
      \par\vspace{0.5em}
      #3
    \end{mathhintbox}
  \fi
}

% \mathsolutioncheck{status}{timestamp}{feedback}
\newcommand{\mathsolutioncheck}[3]{%
  \ifshowhints
    \begin{mathhintbox}
      \textbf{[#1] Solution Check} \hfill \textit{\small #2}
      \par\vspace{0.5em}
      #3
    \end{mathhintbox}
  \fi
}

% Define colors for section delineators
\definecolor{problemcolor}{RGB}{214, 39, 40}
\definecolor{notescolor}{RGB}{148, 103, 189}
\definecolor{solutioncolor}{RGB}{44, 160, 44}
\definecolor{rulecolor}{RGB}{200, 200, 200}

% Storage for context information
\newcommand{\@mathwriteup@author}{}
\newcommand{\@mathwriteup@assignment}{}
\newcommand{\@mathwriteup@disclosure}{}
\newcommand{\@mathwriteup@book}{}
\newcommand{\@mathwriteup@chapter}{}
\newcommand{\@mathwriteup@chaptertitle}{}
\newcommand{\@mathwriteup@section}{}
\newcommand{\@mathwriteup@sectiontitle}{}
\newcommand{\@mathwriteup@problem}{}

% Context command for specifying author, assignment, disclosure, and problem context
% Usage: \mathwriteupcontext{author=Keith Murray, assignment=Homework 1,
%                            disclosure=Generative AI was used,
%                            book=Title, chapter=2, chaptertitle=Flows on the Line,
%                            section=2.1, sectiontitle=A Geometric Way of Thinking, problem=3}
\newcommand{\mathwriteupcontext}[1]{%
  \setkeys{mathwriteup}{#1}%
  \mathwriteup@setupheader%
}

% Key-value parsing
\RequirePackage{keyval}
\define@key{mathwriteup}{author}{\renewcommand{\@mathwriteup@author}{#1}}
\define@key{mathwriteup}{assignment}{\renewcommand{\@mathwriteup@assignment}{#1}}
\define@key{mathwriteup}{disclosure}{\renewcommand{\@mathwriteup@disclosure}{#1}}
\define@key{mathwriteup}{book}{\renewcommand{\@mathwriteup@book}{#1}}
\define@key{mathwriteup}{chapter}{\renewcommand{\@mathwriteup@chapter}{#1}}
\define@key{mathwriteup}{chaptertitle}{\renewcommand{\@mathwriteup@chaptertitle}{#1}}
\define@key{mathwriteup}{section}{\renewcommand{\@mathwriteup@section}{#1}}
\define@key{mathwriteup}{sectiontitle}{\renewcommand{\@mathwriteup@sectiontitle}{#1}}
\define@key{mathwriteup}{problem}{\renewcommand{\@mathwriteup@problem}{#1}}
\define@key{mathwriteup}{lectures}{}  % Parsed by extension, ignored by LaTeX

% Setup fancy header with context information
\newcommand{\mathwriteup@setupheader}{%
  \pagestyle{fancy}%
  \fancyhf{}% Clear all headers and footers
  % Left header: Author name
  \fancyhead[L]{\small\textbf{\@mathwriteup@author}}%
  % Center header: Assignment
  \fancyhead[C]{\small\textbf{\@mathwriteup@assignment}}%
  % Right header: AI disclosure
  \fancyhead[R]{\small\textit{\@mathwriteup@disclosure}}%
  % Footer with page number
  \fancyfoot[C]{\thepage}%
  \renewcommand{\headrulewidth}{0.4pt}%
  \renewcommand{\footrulewidth}{0pt}%
}

% Helper command for section headers
\newcommand{\mathwriteup@sectionheader}[2]{%
  \vspace{1em}%
  \par\noindent{\large\textbf{\textcolor{#1}{#2}}}%
  \vspace{0.5em}%
  \par%
}

% Helper command for section footer
\newcommand{\mathwriteup@sectionfooter}{%
  \vspace{0.5em}%
  \noindent\textcolor{rulecolor}{\rule{\textwidth}{0.5pt}}%
  \vspace{1em}%
}

% Problem environment - contains the problem statement
\newenvironment{problem}{%
  \mathwriteup@sectionheader{problemcolor}{Problem}%
}{%
  \mathwriteup@sectionfooter%
}

% Notes environment - contains student working notes
\newenvironment{notes}{%
  \mathwriteup@sectionheader{notescolor}{Notes}%
}{%
  \mathwriteup@sectionfooter%
}

% Solution environment - contains the solution
\newenvironment{solution}{%
  \mathwriteup@sectionheader{solutioncolor}{Solution}%
}{%
  \mathwriteup@sectionfooter%
}

\endinput
